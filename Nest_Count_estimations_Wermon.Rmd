---
title: "Nest count estimation Wermon"
output: html_notebook
---
#Wermon
```{r echo=FALSE}
rm(list=ls())
source('HILL_BiOp_functions.R')
base_theme <- ggplot2::theme_get()

save.fig <- T

library(bayesplot)
library(mgcv)

# set back to the base theme:
ggplot2::theme_set(base_theme)
```

Moving on to the Wermon dataset.

```{r}
data.0.W <- read.csv('data/W_nests.csv')
# create regularly spaced time series:
data.2.W <- data.frame(Year = rep(min(data.0.W$Year_begin, 
                                       na.rm = T):max(data.0.W$Year_begin, 
                                                      na.rm = T),
                                   each = 12),
                        Month_begin = rep(1:12, 
                                          max(data.0.W$Year_begin, 
                                              na.rm = T) - 
                                            min(data.0.W$Year_begin, 
                                                na.rm = T) + 1)) %>%
  mutate(begin_date = as.Date(paste(Year,
                                    Month_begin,
                                    '01', sep = "-"),
                              format = "%Y-%m-%d"),
         Frac.Year = Year + (Month_begin-0.5)/12) %>%
  select(Year, begin_date, Frac.Year)

# create time-duration filed (in yrs)
# define dates with begin and end dates:
data.0.W %>% mutate(begin_date = as.Date(paste(Year_begin,
                                                Month_begin,
                                                '01', sep = "-"),
                                          format = "%Y-%m-%d")) %>%
  mutate(end_day = if_else(Month_end == 1 | Month_end == 3 | Month_end == 5 |
                             Month_end == 7 | Month_end == 8 | Month_end == 10 |
                             Month_end == 12, 31,
                           if_else(Month_end == 2,
                                   if_else(leap_year(Year_end) == TRUE,
                                           29, 28), 30))) %>%
  mutate(end_date = as.Date(paste(Year_end, Month_end, end_day,
                                  sep = "-"),
                            format = "%Y-%m-%d")) %>%
  mutate(cumu_days = as.numeric(end_date - begin_date[1] + 1),
         num_days = as.numeric(end_date - begin_date) + 1,
         Year = Year_begin,
         Month = Month_begin,
         f_month = as.factor(Month),
         f_year = as.factor(Year),
         Nests = W.1)   %>%
  select(Year, Month, begin_date,
         end_date, num_days, cumu_days,
         f_month, f_year, 
         Nests)  %>%  
  na.omit() %>%
  right_join(.,data.2.W, by = "begin_date") %>%
  reshape::sort_df(.,vars = "Frac.Year") -> data.1.W


```

Raw data look like this. 
```{r}
p.W.all <- ggplot(data.1.W) + 
  geom_point(aes(x = Frac.Year, y = Nests)) + 
  geom_line(aes(x = Frac.Year, y = Nests)) + 
  labs(title = 'Wermon', x = '', 
       y = "Nest counts")

if (save.fig) ggsave(filename = 'figures/W_all.png', 
                     plot = p.W.all,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.all
```

The first data point seems very large... Also, we see a lot of missing values between the mid 2013 and 2016. Data for 2013 seem not so reliable. That's a tough one to fill because no data are available at all... Take a look at annual fluctuations:

```{r warning=FALSE}
data.1.W %>% filter(Nests < 1000) -> data.1.W.2003
p.W.monthly <- ggplot(data.1.W.2003) + 
  geom_point(aes(x = Month, y = Nests, color = f_year)) + 
  geom_line(aes(x = Month, y = Nests, color = f_year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests', title = "Wermon",
       color = "Year")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_monthly.png', 
                     plot = p.W.monthly,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.monthly
```

There are summer and winter peaks: higher values are found in June, July, August, November, December, January, and February.  2003, 2004 and 2005 seem to be outliers with respect to within-year trend, so as 2015. So, I remove them.

```{r}
data.1.W %>% filter(Year.y > 2005 & Year.y != 2015) -> data.1.W.2006

p.W.monthly.2006 <- ggplot(data.1.W.2006) + 
  geom_point(aes(x = Month, y = Nests, color = f_year)) + 
  geom_line(aes(x = Month, y = Nests, color = f_year)) +
  scale_x_continuous(breaks = seq(1, 12, 1)) +
  labs(x = 'Month', y = '# nests', title = "Wermon",
       color = "Year")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_monthly_2006.png', 
                     plot = p.W.monthly.2006,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.monthly.2006
```

The pattern looks more prominent between 2006 and 2017 (2015 are missing). Low counts happen in March, April, September, and October. 

When converting counts into log(counts);

```{r}
p.W.log.count <- ggplot(data.1.W) + 
  geom_point(aes(x = Frac.Year, y = log(Nests))) + 
  geom_line(aes(x = Frac.Year, y = log(Nests))) + 
  labs(x = "", y = "log(count)", title = "Wermon")

if (save.fig) ggsave(filename = 'figures/W_log_count.png', 
                     plot = p.W.log.count,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.log.count
```

First, the entire data are fit with the model with two variance terms; one for low count month, i.e., March, April, September and October, and another for the rest. Results are stored in a .RData file. zm is the posterior samples, Xs.stats.W is the estimated values of the process model, and ys.stats.W is the data. 

```{r}
load("RData/SSAR1_month_W_all_2018-06-12.RData")
zm.W_all <- results.Warmon_SSAR1_month_all$zm
Xs.stats.W_all <- results.Warmon_SSAR1_month_all$Xs.stats
ys.stats.W_all <- results.Warmon_SSAR1_month_all$ys.stats
# Gelman-diagnostic seems okay.
#results.Warmon_SSAR1_month_To2013$g.diag
```

The JAGS model for this analysis is in the following. jm is the JAGS model as it was compiled during the run. 

```{r}
results.Warmon_SSAR1_month_all$jm
```

And the data are here. y is the observed nests, m is months, and T is the length of the time series. Note that the initial large count (1797) is included in this analysis. 

```{r}
results.Warmon_SSAR1_month_all$bugs.data
```

Gelman diagnostic for convergence checking:
```{r}
results.Warmon_SSAR1_month_all$g.diag
```

It doesn't look too bad. 

The posterior of the process parameters look like these. First the densities. 

```{r}
mcmc_dens(zm.W_all, c("sigma.pro1", "sigma.pro2", "theta", "sigma.obs"))
```


The standard deviation of the lower count months (sigma.pro1) is a lot smaller (mean = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro1',1], digits = 3)```, SD = ```r results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro1',2]```) than the other (sigma.pro2, mean = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro2',1], digits = 3)```, SD = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro2', 2], digits = 3)```). Theta is the "slope" parameter for the AR process. sigma.obs is the standard deviation of the observation (mean = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.obs',1], digits = 3)```, SD = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.obs',2], digits = 3)```), which had a long tail and not-so-smooth posterior. 

Trace plots show how sigma.obs did not converge so well, compared with the other three parameters. 

```{r}
mcmc_trace(zm.W_all, c("sigma.pro1", "sigma.pro2", "theta", "sigma.obs"))
```


Then look at the series including the predicted ones. 
```{r}
p.W.predicted.var <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.W_all,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.W_all,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.W_all,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.W_all,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.W_all,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.W_all,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_theta.png', 
                     plot = p.W.predicted.var,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var


```

Red dots are the estimated values, green dots are the observed values, dashed lines are the 95% credible intervals. Seemed to fit fairly well. 

```{r}
dif.Xy_all <- sum((na.omit(Xs.stats.W_all$median_X - ys.stats.W_all$obsY))^2)

dif.Xy_all
```

The sum of squared differences between observed and predicted is ```r signif(dif.Xy_all, digits = 3)``` where there were ```r length(na.omit(Xs.stats.W_all$median_X - ys.stats.W_all$obsY))``` data points. 

I also tried the two-theta two-tau model as it was used for data from JM.

```{r}
#rm(list = c("results.Warmon_SSAR1_month_all"))
load("RData/SSAR1_month_W_var_theta_all_2018-06-12.RData")
zm.W_all2 <- results.W_SSAR1_month_var_theta$zm
Xs.stats.W_all2 <- results.W_SSAR1_month_var_theta$Xs.stats
ys.stats.W_all2 <- results.W_SSAR1_month_var_theta$ys.stats
# Gelman-diagnostic seems okay.
#results.Warmon_SSAR1_month_To2013$g.diag
```

In addition to the two taus as in the previous model, it has two "slope" parameters: one (theta.1) is for May, June, November, and December (increasing months) and the other (theta.2) is for the rest.  

The JAGS model is the following:

```{r}
results.W_SSAR1_month_var_theta$jm
```

And data are here:

```{r}
results.W_SSAR1_month_var_theta$bugs.data
```

Gelman diagnostic for convergence checking:
```{r}
results.W_SSAR1_month_var_theta$g.diag
```

The posterior densities look like the following:

```{r}
mcmc_dens(zm.W_all2, c("sigma.pro1", "sigma.pro2", 
                  "theta.1", "theta.2", "mu", "sigma.obs"))
```

As they were in the previous model, the standard deviation of the lower count months is a lot smaller (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro1',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro1',2], digits = 3)```) than the other (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro2',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro2', 2], digits = 3)```). The theta parameters, however, looked like they overlapped (theta.1: mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.1', 1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.1', 2], digits = 3)```, theta.2: mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.2', 1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.2', 2], digits = 3)```).  As it was in the previous model, sigma.obs did not look like it converged as well as for the other parameters (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.obs',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.obs',2], digits = 3)```), which had a long tail and not-so-smooth posterior. 

Trace plots of these parameters look like the following.

```{r}
mcmc_trace(zm.W_all2, c("sigma.pro1", "sigma.pro2", 
                  "theta.1", "theta.2", "mu", "sigma.obs"))
```


Look at the series including the predicted ones. 
```{r}
p.W.predicted.var <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.W_all2,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.W_all2,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.W_all2,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.W_all2,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.W_all2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.W_all2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_theta.png', 
                     plot = p.W.predicted.var,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var


```

Results don't look any different from before... but the credible intervals seem to be wider for 2014 - 2016. 

```{r}
dif.Xy_all2 <- sum((na.omit(Xs.stats.W_all2$median_X - ys.stats.W_all2$obsY))^2)
dif.Xy_all2
```

The sum of squared differences between observed and predicted is ```r signif(dif.Xy_all2, digits = 3)``` where there were ```r length(na.omit(Xs.stats.W_all2$median_X - ys.stats.W_all2$obsY))``` data points. This was larger than from the previous model. So, the first model seemed to be better than this one using that metric. 

Next, I looked at whether or not the first few large data points and many missing data points may be affecting the predictions at later years. So, I took out before 2004 and see how that fits. I used the one-theta model.

```{r}
#rm(list = c("results.W_SSAR1_month_var_theta"))
load("RData/SSAR1_month_W_2004_2018-06-12.RData")

zm.W_2004 <- results.Warmon_SSAR1_month_2004$zm
Xs.stats.2004 <- results.Warmon_SSAR1_month_2004$Xs.stats
ys.stats.2004 <- results.Warmon_SSAR1_month_2004$ys.stats
```

Confirm the model is still the same.

```{r}
results.Warmon_SSAR1_month_2004$jm
```

And the data:
```{r}
results.Warmon_SSAR1_month_2004$bugs.data
```


Gelman diagnostic:

```{r}
results.Warmon_SSAR1_month_2004$g.diag
```

According to the Gelman diagnostic, convergence was reached for these parameters. 

Posterior densities of the model parameters:

```{r}
mcmc_trace(zm.W_2004, c("sigma.pro1", "sigma.pro2",
                    "theta", "sigma.obs"))
```

None of them look great here... I don't understand why they are worse when just a few extreme data points were taken out. 

And the density plots.

```{r}
mcmc_dens(zm.W_2004, c("sigma.pro1", "sigma.pro2",
                   "theta", "sigma.obs"))
```

sigma.pro1, SD for the low count months (March, April, September, and October), did not converge well and was smaller than when the entire data were used (mean = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.pro1',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.pro1', 2], digits = 3)```). The posterior for the SD of observation model (sigma.obs) looks a lot better than the previous models and the distribution is over larger values (mean = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.obs',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.obs', 2], digits = 3)```)  

Predictions series look like this.

```{r}
p.W.predicted.var.2004 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.2004,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.2004,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.2004,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.2004,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.2004,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.2004,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_2004.png', 
                     plot = p.W.predicted.var.2004,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.2004
```

The crediblel intervals for the missing data in 2014 and 2015 look better than the last run. But... I don't understand why the median of predicted values don't match the observed in this case... are they skewed distributions? So, the means may match with the observed? I think the reason is that the posterior on sigma.obs is a lot bigger than before. 

```{r}
dif.Xy_2004 <- sum((na.omit(Xs.stats.2004$median_X - ys.stats.2004$obsY))^2)
dif.Xy_2004
```

The squared sum of differences between observed and predicted is ```r signif(dif.Xy_2004, digits = 3)``` where there were ```r length(na.omit(Xs.stats.2004$median_X - ys.stats.2004$obsY))``` data points. This was larger than from the previous models. So, the first model seemed to be better than this one using that metric. 

<!-- #```{r} -->
<!-- #summary.zm.W_2004 <- results.Warmon_SSAR1_month_2004$summary.zm -->
<!-- #Xs.stats.2004$mean_X <- summary.zm.W_2004$statistics[grep(pattern = "X[/[]",  -->
<!-- #                                     row.names(summary.zm.W_2004$statistics)),  -->
<!-- #                                "Mean"] -->
<!-- #``` -->

<!-- #```{r} -->
<!-- #p.W.predicted.var.2004 <- p.W.predicted.var.2004 + -->
<!-- #  geom_point(data = Xs.stats.2004, -->
<!-- #             aes(x = time, y = mean_X),  -->
<!-- #             color = "red", shape = 5, -->
<!-- #             alpha = 0.5) -->

<!-- # if (save.fig) ggsave(filename = 'figures/W_predicted_var_2006to2013.png',  -->
<!-- #                      plot = p.W.predicted.var.2006to2013, -->
<!-- #                      dpi = 600, height = 6, width = 8, units = "in") -->
<!-- #p.W.predicted.var.2004 -->
<!-- #``` -->

<!-- # ```{r} -->
<!-- bugs.data.short <- results.Warmon_SSAR1_month_2004$bugs.data -->
<!-- Xs.stats.short <- Xs.stats.2004 -->
<!-- ys.stats.short <- ys.stats.2004 -->

<!-- df.short <- data.frame(time = Xs.stats.short$time, -->
<!--                        obsY = Xs.stats.short$obsY, -->
<!--                        median_X = Xs.stats.short$median_X, -->
<!--                        bugs.Y = bugs.data.short$y) -->

<!-- #rm(list = c("results.Warmon_SSAR1_month_2004")) -->
<!-- load("RData/SSAR1_month_W_all_2018-06-12.RData") -->
<!-- #zm.W <- results.Warmon_SSAR1_month_all$zm -->
<!-- bugs.data.long <- results.Warmon_SSAR1_month_all$bugs.data -->
<!-- Xs.stats.long <- results.Warmon_SSAR1_month_all$Xs.stats -->
<!-- ys.stats.long <- results.Warmon_SSAR1_month_all$ys.stats -->
<!-- df.long <- data.frame(time = Xs.stats.long$time, -->
<!--                        obsY = Xs.stats.long$obsY, -->
<!--                        median_X = Xs.stats.long$median_X, -->
<!--                        bugs.Y = bugs.data.long$y) -->

<!-- ggplot() +  -->
<!--   geom_point(data = df.short,  -->
<!--              aes(x = time, y = obsY), -->
<!--              color = "red", size = 4) +  -->
<!--   geom_point(data = df.short, -->
<!--              aes(x = time, y = bugs.Y), -->
<!--              color = "yellow", size = 3) +  -->
<!--   geom_point(data = df.long, -->
<!--              aes(x = time, y = obsY), -->
<!--              color = "green", size = 2) +  -->
<!--   geom_point(data = df.long, -->
<!--              aes(x = time, y = bugs.Y), -->
<!--              color = "blue", size = 1)   -->

<!-- ``` -->


Now, how about including starting from 2006?
```{r}
load("RData/SSAR1_month_W_2006_2018-06-12.RData")

zm.W_2006 <- results.Warmon_SSAR1_month_2006$zm
Xs.stats.2006 <- results.Warmon_SSAR1_month_2006$Xs.stats
ys.stats.2006 <- results.Warmon_SSAR1_month_2006$ys.stats
```

Confirm the model is still the same.

```{r}
results.Warmon_SSAR1_month_2006$jm
```

And the data:
```{r}
results.Warmon_SSAR1_month_2006$bugs.data
```

Gelman diagnostic:

```{r}
results.Warmon_SSAR1_month_2006$g.diag
```

Convergence seemed to reach fine. Posterior traces. 

```{r}
mcmc_trace(zm.W_2006, c("sigma.pro1", "sigma.pro2",
                    "theta", "sigma.obs"))
```


And the density plots.

```{r}
mcmc_dens(zm.W_2006, c("sigma.pro1", "sigma.pro2",
                   "theta", "sigma.obs"))
```

sigma.pro1, SD for the low count months (March, April, September, and October), is smaller than when the entire data were used (mean = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.pro1',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.pro1', 2], digits = 3)```). The posterior for the SD of observation model (sigma.obs) looks okay (mean = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.obs',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.obs', 2], digits = 3)```)  

Predictions series look like this.

```{r}
p.W.predicted.var.2006 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.2006,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.2006,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.2006,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.2006,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.2006,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.2006,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_2006.png', 
                     plot = p.W.predicted.var.2006,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.2006
```

```{r}
dif.Xy_2006 <- sum((na.omit(Xs.stats.2006$median_X - ys.stats.2006$obsY))^2)
dif.Xy_2006
```

The squared sum of differences between observed and predicted is ```r signif(dif.Xy_2006, digits = 3)``` where there were ```r length(na.omit(Xs.stats.2006$median_X - ys.stats.2006$obsY))``` data points. This was larger than from the previous model. So, the first model seemed to be better than this one using that metric. The crediblel intervals for the missing data, however, look better than the last run. 

```{r}
summary.zm.W_2006 <- results.Warmon_SSAR1_month_2006$summary.zm
Xs.stats.2006$mean_X <- summary.zm.W_2006$statistics[grep(pattern = "X[/[]", 
                                     row.names(summary.zm.W_2006$statistics)), 
                                "Mean"]
```

<!-- Add the means to the plot: -->

<!-- ```{r} -->
<!-- p.W.predicted.var.2006 <- p.W.predicted.var.2006 + -->
<!--   geom_point(data = Xs.stats.2006, -->
<!--              aes(x = time, y = mean_X),  -->
<!--              color = "red", shape = 5, -->
<!--              alpha = 0.5) -->

<!-- # if (save.fig) ggsave(filename = 'figures/W_predicted_var_2006to2013.png',  -->
<!-- #                      plot = p.W.predicted.var.2006to2013, -->
<!-- #                      dpi = 600, height = 6, width = 8, units = "in") -->
<!-- p.W.predicted.var.2006 -->
<!-- ``` -->

I also looked at potential improvements in model fit if I included May as one of low number months. The following does the excatly the same series of analyses as before but adding one more month into the low-count months.

```{r}
load("RData/SSAR1_month_W_all_v2_2018-06-12.RData")

zm.W_all_v2 <- results.Warmon_SSAR1_month_all$zm
Xs.stats.v2 <- results.Warmon_SSAR1_month_all$Xs.stats
ys.stats.v2 <- results.Warmon_SSAR1_month_all$ys.stats
```

Confirm the model is still the same. Note that there is m[t] == 5 in the variance term. The comment was not updated... 

```{r}
results.Warmon_SSAR1_month_all$jm
```

And the data:
```{r}
results.Warmon_SSAR1_month_all$bugs.data
```

Gelman diagnostic:

```{r}
results.Warmon_SSAR1_month_all$g.diag
```

Convergence seemed to reach fine. Posterior traces. 

```{r}
mcmc_trace(zm.W_all_v2, c("sigma.pro1", "sigma.pro2",
                    "theta", "sigma.obs"))
```

Again, sigma.obs doesn't look so good.

And the density plots.

```{r}
mcmc_dens(zm.W_all_v2, c("sigma.pro1", "sigma.pro2",
                   "theta", "sigma.obs"))
```

sigma.pro1, SD for the low count months (March, April, September, and October), is smaller than when the entire data were used (mean = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro1',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.pro1', 2], digits = 3)```). The posterior for the SD of observation model (sigma.obs) looks okay (mean = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.obs',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_all$summary.zm$statistics['sigma.obs', 2], digits = 3)```)  

Predictions series look like this.

```{r}
p.W.predicted.var.v2 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.v2,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.v2,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.v2,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.v2,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_all_v2.png', 
                     plot = p.W.predicted.var.v2,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.v2
```

```{r}
dif.Xy_v2 <- sum((na.omit(Xs.stats.v2$median_X - ys.stats.v2$obsY))^2)
dif.Xy_v2
```

This looks like what it was before - not much difference?

I also tried the two-theta two-tau model.

```{r}
#rm(list = c("results.Warmon_SSAR1_month_all"))
load("RData/SSAR1_month_W_var_theta_all_v2_2018-06-12.RData")
zm.W_all2_v2 <- results.W_SSAR1_month_var_theta$zm
Xs.stats.W_all2_v2 <- results.W_SSAR1_month_var_theta$Xs.stats
ys.stats.W_all2_v2 <- results.W_SSAR1_month_var_theta$ys.stats
# Gelman-diagnostic seems okay.
#results.Warmon_SSAR1_month_To2013$g.diag
```

In addition to the two taus as in the previous model, it has two "slope" parameters: one (theta.1) is for May, June, November, and December (increasing months) and the other (theta.2) is for the rest.  

The JAGS model is the following:

```{r}
results.W_SSAR1_month_var_theta$jm
```

And data are here:

```{r}
results.W_SSAR1_month_var_theta$bugs.data
```

Gelman diagnostic for convergence checking:
```{r}
results.W_SSAR1_month_var_theta$g.diag
```

The posterior densities look like the following:

```{r}
mcmc_dens(zm.W_all2_v2, c("sigma.pro1", "sigma.pro2", 
                  "theta.1", "theta.2", "mu", "sigma.obs"))
```

As they were in the previous model, the standard deviation of the lower count months is a lot smaller (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro1',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro1',2], digits = 3)```) than the other (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro2',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.pro2', 2], digits = 3)```). The theta parameters, however, looked like they overlapped (theta.1: mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.1', 1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.1', 2], digits = 3)```, theta.2: mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.2', 1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['theta.2', 2], digits = 3)```).  As it was in the previous model, sigma.obs did not look like it converged as well as for the other parameters (mean = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.obs',1], digits = 3)```, SD = ```r signif(results.W_SSAR1_month_var_theta$summary.zm$statistics['sigma.obs',2], digits = 3)```), which had a long tail and not-so-smooth posterior. 

Trace plots of these parameters look like the following.

```{r}
mcmc_trace(zm.W_all2_v2, c("sigma.pro1", "sigma.pro2", 
                  "theta.1", "theta.2", "mu", "sigma.obs"))
```


Look at the series including the predicted ones. 
```{r}
p.W.predicted.var.theta_v2 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.W_all2_v2,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.W_all2_v2,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.W_all2_v2,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.W_all2_v2,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.W_all2_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.W_all2_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_theta_v2.png', 
                     plot = p.W.predicted.var.theta_v2,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.theta_v2


```

Results don't look any different from before... but the credible intervals seem to be wider for 2014 - 2016. 

```{r}
dif.Xy_all2_v2 <- sum((na.omit(Xs.stats.W_all2_v2$median_X -
                                 ys.stats.W_all2_v2$obsY))^2)
dif.Xy_all2_v2
```

The sum of squared differences between observed and predicted is ```r signif(dif.Xy_all2_v2, digits = 3)``` where there were ```r length(na.omit(Xs.stats.W_all2_v2$median_X - ys.stats.W_all2_v2$obsY))``` data points. This was larger than from the previous model. So, the first model seemed to be better than this one using that metric. 

Next, I looked at whether or not the first few large data points and many missing data points may be affecting the predictions at later years. So, I took out before 2004 and see how that fits. I used the one-theta model.

```{r}
#rm(list = c("results.W_SSAR1_month_var_theta"))
load("RData/SSAR1_month_W_2004_v2_2018-06-12.RData")

zm.W_2004_v2 <- results.Warmon_SSAR1_month_2004$zm
Xs.stats.2004_v2 <- results.Warmon_SSAR1_month_2004$Xs.stats
ys.stats.2004_v2 <- results.Warmon_SSAR1_month_2004$ys.stats
```

Confirm the model is still the same.

```{r}
results.Warmon_SSAR1_month_2004$jm
```

And the data:
```{r}
results.Warmon_SSAR1_month_2004$bugs.data
```


Gelman diagnostic:

```{r}
results.Warmon_SSAR1_month_2004$g.diag
```

According to the Gelman diagnostic, convergence was reached for these parameters. 

Posterior densities of the model parameters:

```{r}
mcmc_trace(zm.W_2004_v2, c("sigma.pro1", "sigma.pro2",
                    "theta", "sigma.obs"))
```

And the density plots.

```{r}
mcmc_dens(zm.W_2004_v2, c("sigma.pro1", "sigma.pro2",
                   "theta", "sigma.obs"))
```

sigma.pro1, SD for the low count months (March, April, September, and October), did not converge well and was smaller than when the entire data were used (mean = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.pro1',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.pro1', 2], digits = 3)```). The posterior for the SD of observation model (sigma.obs) looks a lot better than the previous models and the distribution is over larger values (mean = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.obs',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2004$summary.zm$statistics['sigma.obs', 2], digits = 3)```)  

Predictions series look like this.

```{r}
p.W.predicted.var.2004_v2 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.2004_v2,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.2004_v2,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.2004_v2,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.2004_v2,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.2004_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.2004_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_2004_v2.png', 
                     plot = p.W.predicted.var.2004_v2,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.2004_v2
```

The crediblel intervals for the missing data in 2014 and 2015 look better than the last run. But... I don't understand why the median of predicted values don't match the observed in this case... are they skewed distributions? So, the means may match with the observed? I think the reason is that the posterior on sigma.obs is a lot bigger than before. 

```{r}
dif.Xy_2004_v2 <- sum((na.omit(Xs.stats.2004_v2$median_X - ys.stats.2004_v2$obsY))^2)
dif.Xy_2004_v2
```

The squared sum of differences between observed and predicted is ```r signif(dif.Xy_2004_v2, digits = 3)``` where there were ```r length(na.omit(Xs.stats.2004_v2$median_X - ys.stats.2004_v2$obsY))``` data points. This was larger than from the previous models. So, the first model seemed to be better than this one using that metric. 


Now, how about including starting from 2006?
```{r}
load("RData/SSAR1_month_W_2006_v2_2018-06-12.RData")

zm.W_2006_v2 <- results.Warmon_SSAR1_month_2006$zm
Xs.stats.2006_v2 <- results.Warmon_SSAR1_month_2006$Xs.stats
ys.stats.2006_v2 <- results.Warmon_SSAR1_month_2006$ys.stats
```

Confirm the model is still the same.

```{r}
results.Warmon_SSAR1_month_2006$jm
```

And the data:
```{r}
results.Warmon_SSAR1_month_2006$bugs.data
```

Gelman diagnostic:

```{r}
results.Warmon_SSAR1_month_2006$g.diag
```

Convergence seemed to reach fine. Posterior traces. 

```{r}
mcmc_trace(zm.W_2006_v2, c("sigma.pro1", "sigma.pro2",
                    "theta", "sigma.obs"))
```


And the density plots.

```{r}
mcmc_dens(zm.W_2006_v2, c("sigma.pro1", "sigma.pro2",
                   "theta", "sigma.obs"))
```

sigma.pro1, SD for the low count months (March, April, September, and October), is smaller than when the entire data were used (mean = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.pro1',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.pro1', 2], digits = 3)```). The posterior for the SD of observation model (sigma.obs) looks okay (mean = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.obs',1], digits = 3)``` and SD = ```r signif(results.Warmon_SSAR1_month_2006$summary.zm$statistics['sigma.obs', 2], digits = 3)```)  

Predictions series look like this.

```{r}
p.W.predicted.var.2006_v2 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats.2006_v2,
            aes(x = time, y = high_X), color = "red",
            linetype = 2) +
  geom_line(data = Xs.stats.2006_v2,
            aes(x = time, y = low_X), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats.2006_v2,
             aes(x = time, y = median_X), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats.2006_v2,
            aes(x = time, y = median_X), color = "red",
            alpha = 0.5) +
  geom_point(data = ys.stats.2006_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)+
  geom_line(data = ys.stats.2006_v2,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) + 
  labs(x = '', y = '# nests', title = "Wermon")  +
  theme(axis.text = element_text(size = 12),
        text = element_text(size = 12))

if (save.fig) ggsave(filename = 'figures/W_predicted_var_2006_v2.png', 
                     plot = p.W.predicted.var.2006_v2,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.predicted.var.2006_v2
```

```{r}
dif.Xy_2006_v2 <- sum((na.omit(Xs.stats.2006_v2$median_X - 
                                 ys.stats.2006_v2$obsY))^2)
dif.Xy_2006_v2
```

The squared sum of differences between observed and predicted is ```r signif(dif.Xy_2006_v2, digits = 3)``` where there were ```r length(na.omit(Xs.stats.2006_v2$median_X - ys.stats.2006_v2$obsY))``` data points. This was larger than from the previous model. So, the first model seemed to be better than this one using that metric. The crediblel intervals for the missing data, however, look better than the last run. 

```{r}
summary.zm.W_2006_v2 <- results.Warmon_SSAR1_month_2006$summary.zm
Xs.stats.2006_v2$mean_X <- summary.zm.W_2006_v2$statistics[grep(pattern = "X[/[]", 
                                     row.names(summary.zm.W_2006_v2$statistics)), 
                                "Mean"]
```

Because using the "2006" data and the two-tau one-theta model without May in the low-count months minizes the credible intervals among all the datasets and models, I decided to use this combination for filling in the missing data. 

```{r}
# sum posterior samples to get annual counts from monthly estimates:
yrs <- as.matrix(c(min(Xs.stats.2006$year):max(Xs.stats.2006$year)))
X.posteriors.all <- lapply(apply(yrs, MARGIN = 1,
                                 FUN = sum.posterior, 
                                 Xs.stats = Xs.stats.2006, 
                                 zm = zm.W_2006),
                           FUN = function(x) rowSums(x$samples))

Xs.year.W2 <- as.data.frame(matrix(unlist(lapply(X.posteriors.all, 
                                                 FUN = quantile,
                                                 c(0.025, 0.5, 0.975))),
                                   ncol = 3, byrow = T)) 

colnames(Xs.year.W2) <- c("low", "total", "high")
Xs.year.W2 <-mutate(Xs.year.W2, 
                    year = c(min(Xs.stats.2006$year):max(Xs.stats.2006$year)))

# Xs.year.W2[Xs.year.W2$year == 2014 | Xs.year.W2$year == 2015, 
#            c("total", "low", "high")] <- NA

data.1.W %>% filter(Year.y < 2006) %>% 
  group_by(Year.y) %>%
  summarise(total = sum(Nests)) %>%
  mutate(low = NA, high = NA) %>%
  rename(year = Year.y) -> Xs.year.2004.2005

Xs.year.W2 <- rbind(Xs.year.2004.2005, Xs.year.W2)

Tapilatu.data <- data.frame(year = c(2003:2012),
                            count = c(2994, 2786, 2805,
                                      1497, 1335, 1483,
                                      1287, 1080, 1354,
                                      1096))

p.W.estimated.counts <- ggplot() + 
  geom_point(data = Xs.year.W2,
             aes(x = year, y = total))+
  geom_errorbar(data = Xs.year.W2,
                aes(x = year, ymin = low, ymax = high)) + 
  geom_point(data = Tapilatu.data,
             aes(x = year, y = count), color = 'red') +
  labs(title = 'Wermon', x = '', y = "Nest counts")

if (save.fig) ggsave(filename = 'figures/W_estimated_counts.png', 
                     plot = p.W.estimated.counts,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.estimated.counts
```

Uncertainty is so big that we can't really tell how the numbers are chaning over time. Just looking at the median:

```{r}
p.W.median.prediction <- ggplot(Xs.year.W2) + 
  geom_point(aes(x = year, y = total))+
  geom_line(aes(x = year, y = total))+
  labs(title = 'Wermon', x = '', y = "Nest counts")

if (save.fig) ggsave(filename = 'figures/W_median_prediction.png', 
                     plot = p.W.median.prediction,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.median.prediction
```

A simple regression analysis up to 2011:

```{r}
dataTo2011.W <- Xs.year.W2 %>% 
  filter(year < 2012) %>% 
  mutate(year.0 = year - 2004)

fitTo2011.W <- glm(log(total) ~ year.0, 
                   family = 'gaussian', 
                   data = dataTo2011.W)
summary(fitTo2011.W)
```

Up to 2011, the rate of decline is ```r signif(coef(fitTo2011.W)[2], digits = 3)```%/year. This is a bit diffrent from Tapilatu et al. (2013), where the authors claimed -11.6%. Probably, the data that went into the analysis were a bit different. In the paper, they stated that "There was also a 62.8% decline at Wermon from 2,994 nests in 2002 to 1,096 in 2011."  The numbers are a bit different from what I have here.

```{r}
dataTo2011.W
```

Using the exact data in the paper:

```{r}
fit.Wermon.Tapilatu <- lm(log(count) ~ year, data = Tapilatu.data)
summary(fit.Wermon.Tapilatu)
```

And we get the same answer. The methods of calculations were different so the exact numbers are different? They were different enough to change the computed rate of decline.  Regardless of the exact numbers, they declined at about the same rate. 

```{r}
new.data.W <- data.frame(year.0 = dataTo2011.W$year.0)
pred.2011.W <- predict(fitTo2011.W, 
                       newdata = new.data.W, 
                       se.fit = T)

pred.2011.W.df <- data.frame(year = dataTo2011.W$year,
                             total = exp(pred.2011.W$fit),
                             se2.high = exp(pred.2011.W$fit + 
                                              pred.2011.W$se.fit * 2),
                             se2.low = exp(pred.2011.W$fit - 
                                             pred.2011.W$se.fit * 2))

p.W.trend.2011 <- ggplot() + 
  geom_point(data = Xs.year.W2,
             aes(x = year, y = total))+
  geom_errorbar(data = Xs.year.W2,
                aes(x = year, ymin = low, ymax = high)) + 
  geom_line(data = pred.2011.W.df,
            aes(x = year, y = total)) +
  geom_line(data = pred.2011.W.df,
            aes(x = year, y = se2.high)) +
  geom_line(data = pred.2011.W.df,
            aes(x = year, y = se2.low)) +
  geom_point(data = Tapilatu.data,
             aes(x = year, y = count), color = 'red') +
  labs(title = 'Wermon', x = '', y = "Nest counts")

if (save.fig) ggsave(filename = 'figures/W_trend_2011.png', 
                     plot = p.W.trend.2011,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.trend.2011
```


What about up to 2017?

```{r}
dataTo2017.W <- Xs.year.W2 %>% mutate(year.0 = year - 2004)

fitTo2017.W <- glm(log(total) ~ year.0, 
                 family = 'gaussian', 
                 data = dataTo2017.W)
summary(fitTo2017.W)
```

The rate of decline is only about ```r signif(coef(fitTo2017.W)[2], digits = 3)``` %/year now. Of course, that's looking just the median values. 

```{r}
new.data.2017.W <- data.frame(year.0 = dataTo2017.W$year.0)
pred.2017.W <- predict(fitTo2017.W, 
                       newdata = new.data.2017.W, 
                       se.fit = T)

pred.2017.W.df <- data.frame(year = dataTo2017.W$year,
                             total = exp(pred.2017.W$fit),
                             se2.high = exp(pred.2017.W$fit + 
                                              pred.2017.W$se.fit * 2),
                             se2.low = exp(pred.2017.W$fit - 
                                             pred.2017.W$se.fit * 2))

p.W.trend.2017 <- ggplot() + 
  geom_point(data = Xs.year.W2,
             aes(x = year, y = total))+
  geom_errorbar(data = Xs.year.W2,
                aes(x = year, ymin = low, ymax = high)) + 
  geom_line(data = pred.2017.W.df,
            aes(x = year, y = total)) +
  geom_line(data = pred.2017.W.df,
            aes(x = year, y = se2.high)) +
  geom_line(data = pred.2017.W.df,
            aes(x = year, y = se2.low))  + 
  geom_point(data = Tapilatu.data,
             aes(x = year, y = count), color = 'red') +

  labs(title = 'Wermon', x = '', y = "Nest counts")

if (save.fig) ggsave(filename = 'figures/W_trend_2017.png', 
                     plot = p.W.trend.2017,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.trend.2017
```

Seems like the first couple data points are not used well... neither are the last few. Fitting a non-linear model:

```{r}
fit.gam.W <- gam(total ~ s(year.0), 
                 data = dataTo2017.W)
sum.gam.W <- summary(fit.gam.W)
sum.gam.W
#plot(fit.gam.1)
```

ACtually it's a pretty good fit and pretty non-linear... 

```{r}
gam.val.W <- plot(fit.gam.W)
gam.val.W.df <- data.frame(x = gam.val.W[[1]]$x,
                           fit = gam.val.W[[1]]$fit,
                           se = gam.val.W[[1]]$se)

Xs.year.W2 %>% mutate(log.total = log(total)) %>%
  mutate(log.total.std = log(total) - mean(log(total), na.rm = T)) %>%
  mutate(total.std = total - mean(total, na.rm = T)) -> Xs.year.W3

p.W.GAM <- ggplot() + 
  geom_line(data = gam.val.W.df,
            aes(x = x+2004, y = fit)) + 
  geom_line(data = gam.val.W.df,
            aes(x = x+2004, y = fit + 2*se), 
            linetype = 2) + 
  geom_line(data = gam.val.W.df,
            aes(x = x+2004, y = fit - 2*se), 
            linetype = 2) + 
  geom_point(data = Xs.year.W3,
             aes(x = year, y = total.std),
             color = 'red') + 
  labs(title = 'Wermon', x = '', 
       y = paste0('GAM(', signif(sum.gam.W$edf, digits = 3), ')'))
  

if (save.fig) ggsave(filename = 'figures/W_GAM.png', 
                     plot = p.W.GAM,
                     dpi = 600, height = 6, 
                     width = 8, units = "in")
p.W.GAM
```

Perhaps, there is an uptick since 2012? 
