---
title: "Nest count imputation - Wermon"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
source("HILL_BiOp_functions.R")
run.date <- "2018-10-22"
```

This document describes how leatherback turtle nest count data were imputed for Wermon. All models were ran separately and results stored in .rds files. 

We use the Bayesian state-space approach, where the mean of the state process is modeled with an auto-regressive model with time lag of one step (AR(1)). 

M[t] = S[t] * X[t-1]

where s[t] is the “slope” parameter between two consecutive counts (transformed into the natural log scale). When s[t] > 1, the counts increase whereas s[t] < 1, they decline. This slope parameter can be constant (s[t] = s for all t), grouped over some time periods (s[t] = s1 for some t, s[t] = s2 otherwise), function of other variables (s[t] = f(k), where k is a vector of one or more variables), or all different. The last option, i.e., s[t] is different for all t, probably is not useful as there would be too many parameters.  We consider the other three options in this study. 

The state is modeled with a normal distribution.

X[t] ~ N(M[t], v[t]),

where v[t] is the variance of X[t]. The variance also can be modeled in a few different scenarios as was in the slope parameter. It can be constant (v[t] = v for all t), grouped over some time periods (v[t] = v1 for some t, v[t] = v2 otherwise), function of other variables (v[t] = f(z), where z is a vector of one or more variables), or all different. Again we consider the three options as before. 

Given the state process, observations are modeled with normal or t distributions. 

Y[t] ~ N(X[t], v.obs)

Y[t] ~ t(X[t], v.obs, df)

where v.obs is the observation variance and df is the degrees-of-freedom parameter of the t distribution. The observation variance is assumed to be constant throughout the dataset. In total 8 models were developed and predictive accuracy was compared to select the most accurate model (Table x).  Model selection process is explained in the subsequent section.  The analysis is conducted in the natural logarithm scale. We define the following:

x[t] = ln(X[t])

m[t] = ln(M[t])

y[t] = ln(Y[t])

s[t] = ln(S[t])

The models were fit to datasets from turtle nesting beaches. Bayesian computations were conducted using jags through jagsUI package in R.  

Initial analyses indicated that missing data for 2014 and 2015 resulted in poor model selection statistics. Consequently, for the model seleciton process, I analyzed the data from 2006 to 2014 first to find the best model, then applied the model to the entire data set (2006 to 2017).

#Model selection using 2006-2014 data
##Model 1
First model is the simplest; the state space is modeled with NOrmal distribution and observation is modeled also with normal distribution. No seasonal change in variance or slope is considered. Then, the model definitions become the following:

m[t] = s + x[t-1]

x[t] ~ N(m[t], v.pro)

y[t] ~ N(x[t], v.obs)

```{r model1, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_W_2006_2014_", run.date, ".rds"))
M1.loo.out <- M$jags.out$loo.out$loo.out
M1.jm <- M$jags.out$jm
```

Diagnostics of the expected log predictive density indicated that the model had poor predictive power, where the majority of estimated Pareto k statistics were greater than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M1, fig.cap = "Figure. PSIS diagnostic plot for M1"}
plot(M1.loo.out)
```

##Model 2
The second model is similar to the first except there were two slope parameters: one for April through July and October through December (increasing months) and another for the remainder: January through March August through September (decreasing months). The model is as follows:

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro)

y[t] ~ N(x[t], v.obs)

```{r model2, cache=T, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_theta_W_2006_2014_", run.date, ".rds"))
M2.loo.out <- M$jags.out$loo.out$loo.out
M2.jm <- M$jags.out$jm
```

Diagnostics of the expected log predictive density indicated that the model was considerably better than the first model. Many of estimated Pareto k parameter was less than 0.7 (```r sum(M2.loo.out$diagnostics$pareto_k < 0.7)``` out of ```r length(M2.loo.out$diagnostics$pareto_k)```).Although ```r sum(M2.loo.out$diagnostics$pareto_k > 0.7)``` were greater than 0.7.  Convergence was reached for all monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```).  

```{r PSIS_M2, fig.cap="Figure. PSIS diagnostic plot for M2"}
plot(M2.loo.out)
```

##Model 3
The third model contained one slope and two variances: one for September and October and another for the rest of the year (this was decided after looking at posteriors of variances when each month was given unique variance parameter - I think...). 

m[t] = s + x[t-1] 

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise.

y[t] ~ N(x[t], v.obs)

```{r model3, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_var_W_2006_2014_", run.date, ".rds"))
M3.loo.out <- M$jags.out$loo.out$loo.out
M3.jm <- M$jags.out$jm

```

Almost all estimated Pareto k statistics were greater than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). We do not consider this model further.

```{r PSIS_M3, fig.cap="Figure. PSIS diagnostic plot for M3"}
plot(M3.loo.out)
```

##Model 4
The fourth model contained two slopes and two variances: combination of Model 2 and Model 3.

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise.

y[t] ~ N(x[t], v.obs)

```{r model4, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_var_theta_W_2006_2014_", run.date, ".rds"))
M4.loo.out <- M$jags.out$loo.out$loo.out
M4.jm <- M$jags.out$jm

```

There were some large estimated Pareto k parameter values, where ```r sum(M4.loo.out$diagnostics$pareto_k < 0.7)``` out of ```r length(M4.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M4, fig.cap="Figure. PSIS diagnostic plot for M4"}
plot(M4.loo.out)
```

##Model 5
In Model 5, a unique variance parameter was given to each month, whereas two seasonal slopes were defined as before.  

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v.pro[month], month = 1, ..., 12

y[t] ~ N(x[t], v.obs)

```{r model5, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_varM_theta_W_2006_2014_", run.date, ".rds"))
M5.loo.out <- M$jags.out$loo.out$loo.out
M5.jm <- M$jags.out$jm

```

Majority of estimated Pareto k parameter values were large, where ```r sum(M5.loo.out$diagnostics$pareto_k < 0.7)``` out of ```r length(M5.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M5, fig.cap="Figure. PSIS diagnostic plot for M5"}
plot(M5.loo.out)
```

##Model 6
In Model 6, a unique slope and variance parameters were given to each month. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v.pro[month], month = 1, ..., 12

y[t] ~ N(x[t], v.obs)

```{r model6, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_varM_thetaM_W_2006_2014_", run.date, ".rds"))
M6.loo.out <- M$jags.out$loo.out$loo.out
M6.jm <- M$jags.out$jm

```

Majority of estimated Pareto k parameters were large, where ```r sum(M6.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M6.loo.out$diagnostics$pareto_k)``` were > 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M6, fig.cap="Figure. PSIS diagnostic plot for M6"}
plot(M6.loo.out)
```

```{r posterior_M6, fig.cap="Figure. Posterior distributions for M6"}
#bayesplot::mcmc_dens(M7.jm$samples, c("theta.1", "theta.2", "sigma.pro1", "sigma.obs"))
```

##Model 7
In Model 7, a unique slope parameter was given to each month, whereas there were two variance2. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise. 

y[t] ~ N(x[t], v.obs, df)

```{r model7, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_var_thetaM_W_2006_2014_", run.date, ".rds"))
M7.loo.out <- M$jags.out$loo.out$loo.out
M7.jm <- M$jags.out$jm

```

There were some large estimated Pareto k parameter values, where ```r sum(M7.loo.out$diagnostics$pareto_k < 0.7)``` out of ```r length(M7.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M7, fig.cap="Figure. PSIS diagnostic plot for M7"}
plot(M7.loo.out)
```

##Model 8
Model 8, a unique slope parameter was given to each month, whereas there was one variance. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro), 

y[t] ~ N(x[t], v.obs)

```{r model8, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_norm_thetaM_W_2006_2014_", run.date, ".rds"))
M8.loo.out <- M$jags.out$loo.out$loo.out
M8.jm <- M$jags.out$jm
```

There were some large estimated Pareto k parameter values, where ```r sum(M8.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M8.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M8, fig.cap="Figure. PSIS diagnostic plot for M8"}
plot(M8.loo.out)
```

##Model 9
Model 9 is similar to Model 1 but uses a different distribution for the state model; the observation is  modeled with t distribution. No seasonal change in variance or slope is considered. 

m[t] = s + x[t-1]

x[t] ~ N(m[t], v.pro)

y[t] ~ t(x[t], v.obs, df)

```{r model9, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_W_2006_2014_", run.date, ".rds"))
M9.loo.out <- M$jags.out$loo.out$loo.out
M9.jm <- M$jags.out$jm
```

There were some large estimated Pareto k parameter values, where ```r sum(M9.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M9.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M9, fig.cap="Figure. PSIS diagnostic plot for M9"}
plot(M9.loo.out)
```


Model 10 is similar to Model 2 except observations are modeled with t distribution.  

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro)

y[t] ~ t(x[t], v.obs, df)

```{r model10, cache=T, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_theta_W_2006_2014_", run.date, ".rds"))
M10.loo.out <- M$jags.out$loo.out$loo.out
M10.jm <- M$jags.out$jm
```

Many of estimated Pareto k parameter was greater than 0.7 (```r sum(M10.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M10.loo.out$diagnostics$pareto_k)```. Convergence was reached for all monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```).  

```{r PSIS_M10, fig.cap="Figure. PSIS diagnostic plot for M10"}
plot(M10.loo.out)
```

##Model 11
The next model contained one slope and two variances: one for September and October and another for the remainder of the year. t distribution was used for observations. 

m[t] = s + x[t-1] 

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 v.pro[t] = v1 if month = 9 or 10, v2 otherwise. 

y[t] ~ t(x[t], v.obs, df)

```{r model11, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_var_W_2006_2014_", run.date, ".rds"))
M11.loo.out <- M$jags.out$loo.out$loo.out
M11.jm <- M$jags.out$jm

```

Majority of estimated Pareto k statistics were greater than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). We do not consider this model further.

```{r PSIS_M11} 
plot(M11.loo.out)
```

##Model 12
Next model contained two slopes and two variances: one slope for January through July and another slope for August through December and one variance for nesting season (May through September) and another variance for the non-nesting season (October through April). Observations are modeled with t distribution.

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise. 

y[t] ~ N(x[t], v.obs, df)

```{r model12, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_var_theta_W_2006_2014_", run.date, ".rds"))
M12.loo.out <- M$jags.out$loo.out$loo.out
M12.jm <- M$jags.out$jm

```

There were many large estimated Pareto k parameter values, where ```r sum(M12.loo.out$diagnostics$pareto_k < 0.7)``` out of ```r length(M12.loo.out$diagnostics$pareto_k)``` were larger than 0.7.  Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M12}
plot(M12.loo.out)
```

##Model 13
In Model 13, a unique variance parameter was given to each month, whereas two seasonal slopes were defined as before.  

m[t] = s[t] + x[t-1], s[t] = s1 if month = 4, 5, 6, 10, 11 or 12. s2 otherwise.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v.pro[month], month = 1, ..., 12

y[t] ~ t(x[t], v.obs, df)

```{r model13, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_varM_theta_W_2006_2014_", run.date, ".rds"))
M13.loo.out <- M$jags.out$loo.out$loo.out
M13.jm <- M$jags.out$jm

```

There were many large estimated Pareto k parameter values, where ```r sum(M13.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M13.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M13}
plot(M13.loo.out)
```

In Model 14, a unique slope and variance parameters were given to each month. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v.pro[month], month = 1, ..., 12

y[t] ~ t(x[t], v.obs, df)

```{r model14, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_varM_thetaM_W_2006_2014_", run.date, ".rds"))
M14.loo.out <- M$jags.out$loo.out$loo.out
M14.jm <- M$jags.out$jm

```

There were many large estimated Pareto k parameter values, where ```r sum(M14.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M14.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r}
plot(M14.loo.out)
```

##Model 15
In Model 15, a unique slope parameter was given to each month, whereas there were two variances. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise.

y[t] ~ t(x[t], v.obs, df)

```{r model15, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_var_thetaM_W_2006_2014_", run.date, ".rds"))
M15.loo.out <- M$jags.out$loo.out$loo.out
M15.jm <- M$jags.out$jm

```

There were some large estimated Pareto k parameter values, where ```r sum(M15.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M15.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r}
plot(M15.loo.out)
```

##Model 16
In Model 16, a unique slope parameter was given to each month, whereas there was one variance. 

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro), 

y[t] ~ t(x[t], v.obs, df)

```{r model16, cache=TRUE, include=TRUE}
M <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_thetaM_W_2006_2014_", run.date, ".rds"))
M16.loo.out <- M$jags.out$loo.out$loo.out
M16.jm <- M$jags.out$jm

```

Several large estimated Pareto k parameter values were found, where ```r sum(M16.loo.out$diagnostics$pareto_k > 0.7)``` out of ```r length(M16.loo.out$diagnostics$pareto_k)``` were larger than 0.7. Convergence statistics indicated acceptable convergence among the monitored parameters (minimum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = min, na.rm = T))), 3)```, mean = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = mean, na.rm = T))), 3)```, and maximum = ```r signif(min(unlist(lapply(M$jags.out$jm$Rhat, FUN = max, na.rm = T))), 3)```). 

```{r PSIS_M16, fig.cap="Figure. PSIS diagnostic plot for M16."}
plot(M16.loo.out)
```

Estimated Pareto k statistics indicated that models 2, 8, 10, 15, and 16 had better predictive performance than the rest. We compared these models using using ELPD values.

```{r ModelComparison, include=TRUE}
M.compare <- compare(M2.loo.out, M8.loo.out, M10.loo.out, M15.loo.out,  M16.loo.out)
print(M.compare)
```

Model 15, which contained month-specific slopes and two variances, turned out to be the best.  

m[t] = s[t] + x[t-1], s[t] = s[month], where month = 1, ..., 12.

x[t] ~ N(m[t], v.pro[t]), v.pro[t] = v1 if month = 9 or 10, v2 otherwise.

y[t] ~ t(x[t], v.obs, df)

The posterior distributions of the model are shown below.

```{r posterior_M15, fig.cap="Figure. Posterior distribuitons of slope parameters for M15"}
bayesplot::mcmc_dens(M15.jm$samples, c("theta.1[1]", "theta.1[2]", "theta.1[3]", "theta.1[4]",
                                      "theta.1[5]", "theta.1[6]", "theta.1[7]", "theta.1[8]",
                                      "theta.1[9]", "theta.1[10]", "theta.1[11]", "theta.1[12]"))
```

```{r posterior_M15_2, fig.cap="Figure. Posterior distributions for the standard deviation of the process (sigma.pro1), standard deviation of observations (sigma.obs), and degrees of freedom (df) parameter."}
bayesplot::mcmc_dens(M15.jm$samples, c("sigma.pro1", "sigma.pro2", "sigma.obs", "df"))
```

The slope parameters indicated increasing trend to July and decreased from August through November. 

We use this model to impute missing data points. First, just look at the 2006-2014 dataset. 

```{r}
M15 <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_var_thetaM_W_2006_2014_", run.date, ".rds"))

Xs.stats <- M15$Xs.stats
ys.stats <- M15$ys.stats
p.1 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(high_X)), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats,
             aes(x = time, y = exp(median_X)), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(median_X)), color = "red",
            alpha = 0.5) +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(low_X)), color = "red",
            linetype = 2) +
  geom_point(data = ys.stats,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5)

print(p.1)
```

Then, combine all counts per year.

```{r }
# need to pool counts per nesting season - not by calendar year
Xs.stats %>% mutate(season = ifelse(month < 4, year - 1, year)) %>% 
  mutate(summer = ifelse(month > 3 & month < 10, 1, 0)) -> Xs.stats
ys.stats %>% mutate(season = ifelse(month < 4, year - 1, year)) %>% 
  mutate(summer = ifelse(month > 3 & month < 10, 1, 0)) -> ys.stats

seasons <- as.matrix(unique(Xs.stats$season))

X.posterior.seasons <- lapply(apply(seasons, 
                                MARGIN = 1,
                                FUN = extract.posterior.jagsUI, 
                                Xs.stats = Xs.stats, 
                                samples = M15.jm$samples),
                          FUN = function(x) exp(x$samples) %>% rowSums())

Xs.season <- as.data.frame(matrix(unlist(lapply(X.posterior.seasons, 
                                              FUN = quantile,
                                              c(0.025, 0.5, 0.975))),
                                ncol = 3, byrow = T)) 
colnames(Xs.season) <- c("low", "median", "high")
Xs.season <-mutate(Xs.season, 
                   season= seasons)

ys.stats %>% group_by(season) %>%
  summarize(obs = sum(obsY, na.rm = T)) -> ys.season

p.W.estimated.counts <- ggplot() + 
  geom_point(data = Xs.season,
             aes(x = season, y = median))+
  geom_errorbar(data = Xs.season,
                aes(x = season, ymin = low, ymax = high)) + 
  geom_point(data = ys.season,
             aes(x = season, y = obs),
             color = "red") +
  labs(title = 'Wermon', x = 'Season', y = "Nest counts")

print(p.W.estimated.counts)
```

Then, bring in the results for the entire dataset. 
```{r}
run.date1 <- "2018-10-23"
M15 <- readRDS(paste0("RData/jagsout_SSAR1_logY_norm_t_var_thetaM_W_2006_2017_", run.date1, ".rds"))

M15$Xs.stats %>% mutate(season = ifelse(month < 4, year - 1, year)) %>% 
  mutate(summer = ifelse(month > 3 & month < 10, 1, 0)) -> Xs.stats

M15$ys.stats %>% mutate(season = ifelse(month < 4, year - 1, year)) %>% 
  mutate(summer = ifelse(month > 3 & month < 10, 1, 0)) -> ys.stats

seasons <- as.matrix(unique(Xs.stats$season))

p.1 <- ggplot() +
  #geom_point(data = ys.stats,
  #           aes(x = time, y = mode_y), color = "blue") +
  #geom_line(data = Xs.stats,
  #          aes(x = time, y = mode_X), color = 'blue') +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(high_X)), color = "red",
            linetype = 2) +
  geom_point(data = Xs.stats,
             aes(x = time, y = exp(median_X)), color = "red",
             alpha = 0.5) +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(median_X)), color = "red",
            alpha = 0.5) +
  geom_line(data = Xs.stats,
            aes(x = time, y = exp(low_X)), color = "red",
            linetype = 2) +
  geom_point(data = ys.stats,
             aes(x = time, y = obsY), color = "green",
             alpha = 0.5) +
  labs(title = "Wermon", y = "Nest counts", x = "Time")

print(p.1)
```

Split between summer and winter. 
```{r}
X.posterior.seasons <- lapply(apply(seasons, 
                                    MARGIN = 1,
                                    FUN = extract.posterior.jagsUI, 
                                    Xs.stats = Xs.stats, 
                                    samples = M15$jags.out$jm$samples),
                              FUN = function(x){
                                n.summer <- exp(x$samples[, x$summer == 1]) %>% rowSums() 
                                n.winter <- exp(x$samples[, x$summer == 0]) %>% rowSums() 
                                return(data.frame(summer = n.summer, winter = n.winter))
                              } )


Xs.season <- as.data.frame(matrix(unlist(lapply(X.posterior.seasons, 
                                                FUN = function(x){
                                                  qtiles <- apply(x, 
                                                                  MARGIN = 2,
                                                                  FUN = quantile, 
                                                                  probs = c(0.025, 0.5, 0.975))})),
                                  ncol = 6, byrow = T))

colnames(Xs.season) <- c("Summer.low", "Summer.median", "Summer.high",
                         "Winter.low", "Winter.median", "Winter.high")
Xs.season <-mutate(Xs.season, 
                   season= seasons)

ys.stats %>% group_by(season, summer) %>%
  summarize(obs = sum(obsY, na.rm = T)) -> tmp.y.season

ys.season <- data.frame(season = seasons,
                        summer = unlist(c(NA, as.vector(filter(tmp.y.season, summer == 1)[, "obs"]))),
                        winter = unlist(filter(tmp.y.season, summer == 0)[, "obs"]))
  
p.W.estimated.counts <- ggplot() + 
  geom_point(data = Xs.season,
             aes(x = season, 
                 y = Summer.median), 
             color = "red")+
  geom_errorbar(data = Xs.season,
                aes(x = season, 
                    ymin = Summer.low, 
                    ymax = Summer.high), 
                color = "red") + 
  geom_point(data = ys.season,
             aes(x = season, 
                 y = summer),
             color = "green") +
  geom_point(data = Xs.season,
             aes(x = season+0.5, 
                 y = Winter.median), 
             color = "blue")+
  geom_errorbar(data = Xs.season,
                aes(x = season+0.5, 
                    ymin = Winter.low, 
                    ymax = Winter.high), 
                color = "blue") + 
  geom_point(data = ys.season,
             aes(x = season+0.5, 
                 y = winter),
             color = "green") +
  
  labs(title = 'Wermon', x = 'Season', y = "Nest counts")

print(p.W.estimated.counts)

write.csv(Xs.season, file = "data/estimatedX_M15.csv",
          quote = F, row.names = F)

```

